import Head from "next/head";
import styles from "../../styles/pages/payment/applyInvitation.module.scss";
import { PAGE } from "../../constants";
import Divider from "../../components/divider/divider";
import { getData, putData } from "../../api/fetch";
import Swal from "sweetalert2";
import jwtDecode from "jwt-decode";
import InputText from "../../components/inputs/inputText";
import InputSelect from "../../components/inputs/inputSelect";
import { cityDistrict } from "../../constants/cityDistrict";
import router from "next/router";
import Form from "../../components/forms/form";
import InputTextbox from "../../components/inputs/inputTextbox";
import Card from "../../components/cards/card";
import MainColorButton from "../../components/buttons/mainColorButton";
import { getFormValues } from "../../utils/getFormValues";
import LayoutMain from "../../components/Layout/layoutMain";
import InputCheckbox from "../../components/inputs/inputCheckbox";
import { useState, useEffect } from "react";

export default function ApplyInvitation() {
  const [pageLoading, setPageLoading] = useState(true);
  const [user, setUser] = useState({});
  const [districts, setDistricts] = useState([]);
  const [liveLoading, setLiveLoading] = useState(false);
  const [hennaCheck, setHennaCheck] = useState(true);

  const getCartLength = async () => {
    return await getData("/api/cart/getCartLength")
      .then((res) => {
        return res.data.length;
      })
      .catch(() => {
        return router.push(PAGE.home.href);
      });
  };
  const getCartApproved = async () => {
    return await getData("/api/cart/getCartApproved")
      .then((res) => {
        return res.data.approved;
      })
      .catch(() => {
        return router.push(PAGE.home.href);
      });
  };

  useEffect(() => {
    (async () => {
      const cartLength = await getCartLength();
      const cartApproved = await getCartApproved();
      if (cartLength > 0 && cartApproved) {
        setPageLoading(false);
      } else {
        router.push(PAGE.login.href);
      }
    })();
  }, []);

  const onApply = async (e) => {
    e.preventDefault();
    setLiveLoading(true);
    // If select same address to ship and billing
    const values = getFormValues("invitation-form");
    var isErrorGived = false;
    if (hennaCheck) {
      await Object.keys(values).map((item) => {
        if (values[item].length <= 0) {
          return (isErrorGived = true);
        }
      });
    } else {
      await Object.keys(values).map((item) => {
        if (values[item].length <= 0 && !item.includes("henna")) {
          return (isErrorGived = true);
        }
      });
    }

    if (!isErrorGived) {
      await putData("/api/member/updateInvitation", values)
        .then(() => {
          return router.push(PAGE.applyAddress.href);
        })
        .catch(() => {
          Swal.fire({
            icon: "error",
            title: "Hata!",
            text: "Lütfen tekrar deneyiniz.",
          });
        });
    } else {
      Swal.fire({
        icon: "error",
        title: "Hata!",
        text: "Lütfen gerekli yerleri doldurunuz.",
      });
    }

    setLiveLoading(false);
  };

  const onChangeHennaCheckbox = (e) => {
    const value = e.target.checked;
    setHennaCheck(value);
  };

  return (
    <div>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <LayoutMain liveLoading={liveLoading} pageLoading={pageLoading}>
        <div className={styles.containerMain}>
          <div className={styles.container}>
            <div className={styles.leftContainer}>
              <Card width="812px" padding="15px">
                <Divider direction="left">Davetiye Bilgileri</Divider>
                <Form id="invitation-form">
                  <div className={styles.rowContainer}>
                    <InputText
                      labelText="Gelinin Adı Soyadı"
                      width="85%"
                      name="brideFullname"
                    />
                    <InputText
                      labelText="Damadın Adı Soyadı"
                      width="85%"
                      name="groomFullname"
                    />
                  </div>
                  <div className={styles.rowContainer}>
                    <InputText
                      labelText="Gelinin Anne Baba Adı"
                      width="85%"
                      name="brideParentsName"
                    />
                    <InputText
                      labelText="Damadın Anne Baba Adı"
                      width="85%"
                      name="groomParentsName"
                    />
                  </div>
                  <div className={styles.fluidContainer}>
                    <InputText
                      labelText="Düğün Tarihi"
                      width="92.5%"
                      name="weddingDate"
                    />
                  </div>
                  <div className={styles.rowContainer}>
                    <InputText
                      labelText="Düğün Başlangıç Saati"
                      width="85%"
                      name="weddingStartTime"
                    />
                    <InputText
                      labelText="Düğün Bitiş Saati"
                      width="85%"
                      name="weddingEndTime"
                    />
                  </div>
                  <div className={styles.rowContainer}>
                    <InputText
                      labelText="Düğün Yeri"
                      width="85%"
                      name="weddingLocation"
                    />
                    <InputText
                      labelText="Düğün Adresi"
                      width="85%"
                      name="weddingAddress"
                    />
                  </div>
                  <div className={styles.checkboxContainer}>
                    <InputCheckbox
                      defaultChecked={true}
                      onChange={onChangeHennaCheckbox}
                    />
                    <span>Kına yapacak mısınız?</span>
                  </div>

                  {hennaCheck ? (
                    <>
                      <div className={styles.fluidContainer}>
                        <InputText
                          labelText="Kına Tarihi"
                          width="92.5%"
                          name="hennaDate"
                        />
                      </div>
                      <div className={styles.rowContainer}>
                        <InputText
                          labelText="Kına Başlangıç Saati"
                          width="85%"
                          name="hennaStartTime"
                        />
                        <InputText
                          labelText="Kına Bitiş Saati"
                          width="85%"
                          name="hennaEndTime"
                        />
                      </div>
                      <div className={styles.rowContainer}>
                        <InputText
                          labelText="Kına Yeri"
                          width="85%"
                          name="hennaLocation"
                        />
                        <InputText
                          labelText="Kına Adresi"
                          width="85%"
                          name="hennaAddress"
                        />
                      </div>
                    </>
                  ) : (
                    <></>
                  )}
                  <div className={styles.fluidContainer}>
                    <InputText
                      labelText="Davetiye Sözü"
                      width="92.5%"
                      name="invitationWord"
                    />
                  </div>
                  <div className={styles.fluidContainer}>
                    <InputText
                      labelText="WhatsApp Numaranız"
                      width="92.5%"
                      name="whatsappNumber"
                    />
                  </div>

                  <span className={styles.warnText}>
                    Verdiğiniz bilgilerle size WhatsApp üzerinden tasarım
                    gönderilecektir. Siz tasarımı onaylamadığınız sürece
                    kesinlikle baskı olmayacaktır.
                  </span>
                  <div className={styles.applyButton}>
                    <MainColorButton
                      text="Onayla"
                      width="100%"
                      height="40px"
                      onClick={onApply}
                    />
                  </div>
                </Form>
              </Card>
            </div>
            <div className={styles.spacer}></div>
            <div className={styles.rightContainer}>
              <MainColorButton
                text="Onayla"
                width="248px"
                height="40px"
                onClick={onApply}
              />
            </div>
          </div>
        </div>
      </LayoutMain>
    </div>
  );
}
